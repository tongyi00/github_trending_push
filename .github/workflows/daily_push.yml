name: Daily Trending Push

on:
  schedule:
    # 00:00 UTC = 08:00 Beijing Time
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-daily-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Need write permission to push trending.json back

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Generate config.yaml
      env:
        # Load secrets from GitHub Actions
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }} # Optional
      run: |
        # Use python to generate config.yaml safely
        python -c "
        import os
        import yaml

        # Load the example config as a template
        with open('config/config.example.yaml', 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)

        # Update fields with secrets if they exist
        if os.environ.get('EMAIL_SENDER'):
            config['email']['sender'] = os.environ['EMAIL_SENDER']

        if os.environ.get('EMAIL_PASSWORD'):
            config['email']['password'] = os.environ['EMAIL_PASSWORD']

        if os.environ.get('EMAIL_RECIPIENTS'):
            # Handle comma-separated list or single email
            recipients = os.environ['EMAIL_RECIPIENTS'].split(',')
            config['email']['recipients'] = [r.strip() for r in recipients if r.strip()]

        if os.environ.get('DEEPSEEK_API_KEY'):
            config['ai_models']['deepseek']['api_key'] = os.environ['DEEPSEEK_API_KEY']

        if os.environ.get('NVIDIA_API_KEY'):
            config['ai_models']['nvidia']['api_key'] = os.environ['NVIDIA_API_KEY']

        if os.environ.get('GH_API_TOKEN'):
            config['github']['token'] = os.environ['GH_API_TOKEN']

        # Save to actual config path
        with open('config/config.yaml', 'w', encoding='utf-8') as f:
            yaml.dump(config, f, allow_unicode=True)
        "

    - name: Run Daily Push
      run: |
        # Start API server in background with scheduler
        python start_api.py &
        API_PID=$!

        # Wait for server to initialize
        sleep 5

        # Trigger daily task via API
        curl -X POST http://localhost:8000/api/tasks/run \
          -H "Content-Type: application/json" \
          -d '{"task_type": "daily"}'

        # Wait for task to complete (adjust timeout as needed)
        sleep 60

        # Stop server
        kill $API_PID

    - name: Commit and Push History
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

        # Check if data/trending.json has changed
        if [[ -n $(git status --porcelain data/trending.json) ]]; then
          git add data/trending.json
          git commit -m "Update trending history [skip ci]"
          git push
        else
          echo "No changes to trending history."
        fi
